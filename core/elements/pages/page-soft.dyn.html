<dom-module id="page-soft">
  <template>
    
    <paper-card heading="[[page.title]]">
      <template is="dom-if" if="[[isMD]]" restamp>
        <div class="card-content">
          <juicy-markdown value="[[pageResponseData]]"></juicy-markdown>
        </div>
      </template>
      <template is="dom-if" if="[[isHTML]]" restamp>
        <div class="card-content">
          <template is="juicy-html" content$="[[pageResponseData]]"></template>
        </div>
      </template>
      <template is="dom-if" if="[[isPDF]]" restamp>
        <div class="card-content">
          <pdf-object file="[[pageUrl]]" height="400px"></pdf-object>
        </div>
        <div class="card-actions">
          <paper-button on-click="_download">Fullscreen</paper-button>
        </div>
      </template>
    </paper-card>
    
    <iron-ajax id="page"
      url="[[pageUrl]]"
      handle-as="text"
      on-response="pageResponse"
      on-error="pageError"
      last-response="{{pageResponseData}}"
    ></iron-ajax>
    
  </template>

  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'page-soft',
        
        properties: {
          pageResponseData: {
            type: String
          },
          page: {
            type: Object,
            observer: '_pageChanged'
          }
        },
        
        _pageChanged: function() {
          this._determinePage();
        },
        
        _determinePage: function() {
          var formats = ['md', 'html', 'pdf'];
          this._formats = [];
          for (var i = 0; i < formats.length; i++) {
            if (formats[i] != this.page.format) {
              this.push('_formats', formats[i]);
            }
          }
          this._pageUrl = '../../../../../../../../content/pages/' + this.page.slug + '.' + this.page.format;
          this._checkFile(this._pageUrl, function() { // file exists
            this.pageUrl = this._pageUrl;
            this._initPage();
          }.bind(this), function() { // file doesn't exist
            this._pageUrl = '../../../../../../../../content/pages/' + this.page.slug + '.' + this._formats[0];
            this._checkFile(this._pageUrl, function() { // file exists
              this.pageUrl = this._pageUrl;
              this.page.format = this._formats[0];
              this._initPage();
            }.bind(this), function() { // file doesn't exist
              this._pageUrl = '../../../../../../../../content/pages/' + this.page.slug + '.' + this._formats[1];
              this._checkFile(this._pageUrl, function() { // file exists
                this.pageUrl = this._pageUrl;
                this.page.format = this._formats[1];
                this._initPage();
              }.bind(this), function() { // file doesn't exist
                this.pageUrl = null;
              }.bind(this));
            }.bind(this));
          }.bind(this));
        },
        
        _initPage: function() {
          if (this.page.format === 'md' || this.page.format === 'html') {
            this.$.page.generateRequest();
          } else {
            this._loadPage();
          }
        },
        
        pageResponse: function() {
          this._loadPage();
        },
        
        pageError: function() {
          var error = 'Error 2: ' + this.page.slug + '.' + this.page.format + ' failed to load';
          app.debug(error, 'warn');
          app.toast(error, 'http://blogdown.info/error/2', '_blank');
        },
        
        _loadPage: function() {
          switch (this.page.format) {
            case 'md':
              this.isMD = true;
              this.isHTML = false;
              this.isPDF = false;
              break;
            case 'html':
              this.isMD = false;
              this.isHTML = true;
              this.isPDF = false;
              break;
            case 'pdf':
              this.isMD = false;
              this.isHTML = false;
              this.isPDF = true;
              break;
          }
          app.debug(this.page.slug + '.' + this.page.format + ' loaded');
        },
        
        _download: function() {
          window.open(this.pageUrl);
        },
        
        _checkFile: function(url, success, error) {
          var xmlHttpReq = false;
          var self = this;
          if (window.XMLHttpRequest) { // Mozilla/Safari
            self.xmlHttpReq = new XMLHttpRequest();
          }
          else if (window.ActiveXObject) { // IE
            self.xmlHttpReq = new ActiveXObject("Microsoft.XMLHTTP");
          }
          self.xmlHttpReq.open('HEAD', url, true);
          self.xmlHttpReq.onreadystatechange = function() {
            if (self.xmlHttpReq.readyState == 4) {
              if (self.xmlHttpReq.status == 200) {
                success();
              } else if (self.xmlHttpReq.status == 404) {
                error();
              }
            }
          }
          self.xmlHttpReq.send();
        }
      });
    })();
  </script>

</dom-module>
